<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.17"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>AWS IoT Device Client: Jobs</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">AWS IoT Device Client
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.17 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
var searchBox = new SearchBox("searchBox", "search",false,'Search');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */</script>
<div id="main-nav"></div>
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

</div><!-- top -->
<div class="PageDoc"><div class="header">
  <div class="headertitle">
<div class="title">Jobs </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p><b>Notice:</b> Running the AWS IoT Device Client will incur usage of AWS IoT services, and is likely to incur charges on your AWS account. Please refer the pricing pages for <a href="https://aws.amazon.com/iot-core/pricing/">AWS IoT Core</a>, <a href="https://aws.amazon.com/iot-device-management/pricing/">AWS IoT Device Management</a>, and <a href="https://aws.amazon.com/iot-device-defender/pricing/">AWS IoT Device Defender</a> for more details.</p>
<ul>
<li><a href="#jobs-feature">Jobs Feature</a><ul>
<li><a href="#sample-jobs">Sample Jobs</a></li>
<li><a href="#creating-a-job">Creating a Job</a></li>
<li><a href="#creating-your-own-job-handler">Creating your own Job Handler</a><ul>
<li><a href="#jobjob-handler-security-considerations">Job/Job Handler Security Considerations</a></li>
</ul>
</li>
<li><a href="#debugging-your-job">Debugging your Job</a></li>
<li><a href="#jobs-build-flags">Jobs Build Flags</a></li>
<li><a href="#jobs-feature-configuration-options">Jobs Feature Configuration Options</a><ul>
<li><a href="#configuring-the-jobs-feature-via-the-command-line">Configuring the Jobs feature via the command line</a></li>
<li><a href="#configuring-the-jobs-feature-via-the-json-configuration-file">Configuring the Jobs feature via the JSON configuration file</a></li>
</ul>
</li>
</ul>
</li>
</ul>
<p>../../README.md "*Back To The Main Readme*"</p>
<h1><a class="anchor" id="autotoc_md20"></a>
Jobs Feature</h1>
<p>The Jobs feature within the AWS IoT Device Client provides device-side functionality for execution of <a href="https://docs.aws.amazon.com/iot/latest/developerguide/iot-jobs.html">jobs created</a>. When the Jobs feature starts within the AWS IoT Device Client, the feature will attempt to establish subscriptions to important notification topics, and will also publish a request to receive the latest pending jobs. It will use the shared MQTT connection to subscribe/publish to these topics.</p>
<p>When a new Job is received via these topics, the Jobs feature will look for and extract the following required and optional elements:</p>
<h2><a class="anchor" id="autotoc_md21"></a>
Sample Jobs</h2>
<p>Existing <a href="../../sample-job-docs">Sample Job Docs</a> Existing <a href="../../sample-job-handlers">Sample Job Handlers</a></p>
<h2><a class="anchor" id="autotoc_md22"></a>
Creating a Job</h2>
<p><a href="../../sample-job-docs/install-packages.json">View a sample job document here</a></p>
<p>The following fields are extracted from the incoming Job document by the Jobs feature within the AWS IoT Device Client when a job is received.</p>
<p><code>operation</code> <em>string</em> (Required): This is the executable or script that you'd like to run. Here we can specify a script located in the Device Client's handler directory, such as <code>install-packages.sh</code>, or it could be a well known executable binary in the Device Client's environmentx path, such as <code>echo</code> or <code>apt-get</code>.</p>
<p><code>args</code> <em>string array</em> (Optional): This is a JSON array of string arguments which will be passed to the specified operation. For example, if we want to run our <code>install-packages.sh</code> to install the package <code>ifupdown</code>, our args field would look like: </p><div class="fragment"><div class="line">...</div>
<div class="line">&quot;args&quot;: [&quot;ifupdown&quot;],</div>
<div class="line">...</div>
</div><!-- fragment --><p>If we wanted our remote device to print out "Hello World", then our job document so far might look like: </p><div class="fragment"><div class="line">{</div>
<div class="line">    &quot;operation&quot;: &quot;echo&quot;,</div>
<div class="line">    &quot;args&quot;: [&quot;Hello world!&quot;]</div>
<div class="line">}</div>
</div><!-- fragment --><p><code>path</code> <em>string</em> (Optional): This field tells the Jobs feature where it should look to find an executable that matches the specified operation. If this field is omitted, the Jobs feature will assume that the executable can be found in the <code>PATH</code> environment variable. If you expect that the executable (operation) should be found in the Job feature's handler directory (~/.aws-iot-device-client/jobs by default or specified via command line/json configuration values), then the path must be specified as part of the job document as follows: </p><div class="fragment"><div class="line">...</div>
<div class="line">&quot;path&quot;: &quot;default&quot;,</div>
<div class="line">...</div>
</div><!-- fragment --><p>The path could also be specified as a particular directory that is expected on the device, such as: </p><div class="fragment"><div class="line">...</div>
<div class="line">&quot;path&quot;: &quot;/home/ubuntu/my-job-handler-folder&quot;</div>
<div class="line">...</div>
</div><!-- fragment --><p><code>includeStdOut</code> <em>boolean</em> (Optional): This field tells the Jobs feature whether the standard output (STDOUT) of the child process should be included in the job execution update that is published to the IoT Jobs service. For example: </p><div class="fragment"><div class="line">...</div>
<div class="line">&quot;includeStdOut&quot;: true,</div>
<div class="line">...</div>
</div><!-- fragment --><p><code>allowStdErr</code> <em>integer</em> (Optional): This field tells the Jobs feature whether a specific number of lines of output on STDERR from the job handler may be acceptable. If this field is omitted, the Jobs feature will use a default of 0 (zero), meaning that any lines of output on STDERR will cause the job to be marked as failed. For example: </p><div class="fragment"><div class="line">...</div>
<div class="line">&quot;allowStdErr&quot;: 2,</div>
<div class="line">...</div>
</div><!-- fragment --><p>This job document indicates that the Jobs feature will mark the job as a success if the return code of the process is 0 AND there are fewer than or equal to 2 (two) lines of standard error output from the job handler.</p>
<h2><a class="anchor" id="autotoc_md23"></a>
Creating your own Job Handler</h2>
<p>The Jobs feature within the AWS IoT Device Client handles establishing and maintaining a connection to AWS IoT Core and making sure that jobs are delivered to your device, but Job handlers represent the actual business logic that you want to execute on your device.</p>
<p>For example, we might want to create a new application written in Python called "foo" that should be run whenever our device receives a "foo" job. After writing the foo application, which for this particular example might only consist of a single file called <code>Foo.py</code>, here's the steps that we would need to go through to set our AWS IoT Device Client to automatically trigger foo:</p>
<ol type="1">
<li>Add <code>Foo.py</code> to our Job Handler Directory: By default, the Jobs feature will look at <code>~/.aws-iot-device-client/jobs/</code> for a handler, so we should put <code>Foo.py</code> here (where <code>~/</code> represents the home directory of the user that will run the Device Client - <code>/root</code> if we're running the AWS IoT Device Client as a service, or <code>/home/ubuntu/</code> if we're running under the default Ubuntu user). The new path then looks something like <code>/home/ubuntu/.aws-iot-device-client/jobs/Foo.py</code>.</li>
<li>Set Foo's file permissions: All job handlers that we place in the AWS IoT Device Client's handler directory need to have permissions of <code>700</code>, meaning the user that owns it has read, write, and execute permissions while all other users do not have any permissions for this file. You can typically set these permissions correctly with <code>chmod 700 Foo.py</code> on most linux systems.</li>
<li>Make sure the AWS IoT Device Client is running: If the AWS IoT Device Client is already running, you can skip this step since the AWS IoT Device Client will dynamically load your Job handle when it receives a corresponding job. If it's not running, you can start the client as the current user by running <code>./aws-iot-device-client</code>, or if you've already installed the client as a service, you can probably run something similar to <code>sudo systemctl start aws-iot-device-client.service</code></li>
<li>Create a Job targeting your thing: Now that the AWS IoT Device Client is running on our device, we can create a job either through the AWS Console or through the AWS CLI. For example, here's how we might create a job targeting a device on the command line: <div class="fragment"><div class="line">aws iot create-job --job-id run-foo --document &quot;{\&quot;operation\&quot;: \&quot;Foo.py\&quot;, \&quot;path\&quot;: \&quot;default\&quot;}&quot; --targets arn:aws:iot:us-west-2:XXXXXXXXXX:thing/my-thing</div>
</div><!-- fragment --></li>
</ol>
<p>After creating this job, a notification will be sent from the AWS IoT Core endpoint via MQTT to the AWS IoT Device Client running on your target thing. The Device Client will automatically invoke Foo.py and will update the job execution status once Foo.py returns.</p>
<p>For more examples of how a Job handler can be implemented, check out the sample job handlers within this package under the <code>sample-job-handlers</code> directory.</p>
<h3><a class="anchor" id="autotoc_md24"></a>
Job/Job Handler Security Considerations</h3>
<p>When creating a job, it's critically important that you consider the risks associated with executing particular commands on the device. For example, running a job that prints the contents of secure credentials to STDOUT or STDERR will cause these contents to enter the AWS IoT Device Client logs, and may run the risk of exposing these credentials to an attacker if the logs are not properly secured.</p>
<p>We recommend avoiding execution of any jobs that may reveal or leak sensitive information such as credentials , private keys, or sensitive files as well as assignment of appropriately restrictive permissions for your credentials /sensitive files.</p>
<h2><a class="anchor" id="autotoc_md25"></a>
Debugging your Job</h2>
<p>Once you've set up your job handlers and started targeting your thing or thing group with jobs, you may need to perform a diagnosis in the event that your job fails. The Jobs feature within the AWS IoT Device Client automatically publishes the last <code>1024</code> characters (this is a maximum limit enforced by the Jobs service) of your job process's standard error output as part of the job execution update. To view the standard error (STDERR) output from your device, use the AWS CLI as shown in the example below to describe the job execution. The STDERR output is shown in the response body as part of the status details in a field labeled 'stderr'.</p>
<div class="fragment"><div class="line">aws iot describe-job-execution --region us-west-2 --job-id 7ff399d0-87f7-rebootstage0-reboot-setup --thing-name my-test-thing</div>
<div class="line">{</div>
<div class="line">    &quot;execution&quot;: {</div>
<div class="line">        &quot;jobId&quot;: &quot;7ff399d0-87f7-rebootstage0-reboot-setup&quot;,</div>
<div class="line">        &quot;status&quot;: &quot;FAILED&quot;,</div>
<div class="line">        &quot;statusDetails&quot;: {</div>
<div class="line">            &quot;detailsMap&quot;: {</div>
<div class="line">                &quot;reason&quot;: &quot;Exited with status: 1&quot;,</div>
<div class="line">                &quot;stderr&quot;: &quot;mv: cannot stat &#39;/sbin/reboot-invalid&#39;: No such file or directory\n&quot;</div>
<div class="line">            }</div>
<div class="line">        },</div>
<div class="line">        &quot;thingArn&quot;: &quot;arn:aws:iot:us-west-2:XXXXXXXXXX:thing/my-test-thing&quot;,</div>
<div class="line">        &quot;queuedAt&quot;: &quot;2020-12-02T14:48:38.705000-08:00&quot;,</div>
<div class="line">        &quot;startedAt&quot;: &quot;2020-12-02T16:15:11.677000-08:00&quot;,</div>
<div class="line">        &quot;lastUpdatedAt&quot;: &quot;2020-12-02T16:15:11.677000-08:00&quot;,</div>
<div class="line">        &quot;executionNumber&quot;: 1,</div>
<div class="line">        &quot;versionNumber&quot;: 2</div>
<div class="line">    }</div>
<div class="line">}</div>
</div><!-- fragment --><p>If the STDERR output alone is insufficient, we recommend setting the <code>includeStdOut</code> flag to true within your Job document. By setting this flag to true, the Jobs feature within the AWS IoT Device Client will publish the last <code>1024</code> characters of standard output (STDOUT) as part of the job execution update to assist with debugging. Below is an example of how to add this to your job document:</p>
<div class="fragment"><div class="line">...</div>
<div class="line">&quot;includeStdOut&quot;: true,</div>
<div class="line">...</div>
</div><!-- fragment --><h2><a class="anchor" id="autotoc_md26"></a>
Jobs Build Flags</h2>
<p><code>-DEXCLUDE_JOBS</code>: If this flag is set to ON, symbols related to the Jobs feature will not be included in the output binary. If this flag is not included, the Jobs feature will be included in the output binary.</p>
<p>Example: </p><div class="fragment"><div class="line">cmake ../ -DEXCLUDE_JOBS=ON</div>
</div><!-- fragment --><h2><a class="anchor" id="autotoc_md27"></a>
Jobs Feature Configuration Options</h2>
<p><code>enabled</code>: Whether or not the jobs feature is enabled (True/False).</p>
<p><code>handler-directory</code>: A path to a directory containing scripts or executables that the Jobs feature should look in when receiving an incoming job. If there is a script or executable in the directory that matches the name of the operation passed as part of the incoming job document, the Job feature will automatically execute it and will update the job based on the performance of the specified executable. This directory should have permissions of <code>700</code>, and any script/executable in this directory should have permissions of <code>700</code>. If these permissions are not found, the Jobs feature will not execute the scripts or executables in this directory.</p>
<h3><a class="anchor" id="autotoc_md28"></a>
Configuring the Jobs feature via the command line</h3>
<div class="fragment"><div class="line">./aws-iot-device-client --enable-jobs [true|false] --jobs-handler-dir [your/path/to/job/handler/directory/]</div>
</div><!-- fragment --><p>Example: </p><div class="fragment"><div class="line">./aws-iot-device-client --enable-jobs true --jobs-handler-dir ~/.aws-iot-device-client/jobs/</div>
</div><!-- fragment --><h3><a class="anchor" id="autotoc_md29"></a>
Configuring the Jobs feature via the JSON configuration file</h3>
<div class="fragment"><div class="line">{</div>
<div class="line">    ...</div>
<div class="line">    &quot;jobs&quot;: {</div>
<div class="line">        &quot;enabled&quot;: [true|false],</div>
<div class="line">        &quot;handler-directory&quot;: &quot;[your/path/to/job/handler/directory/]&quot;</div>
<div class="line">    }</div>
<div class="line">    ...</div>
<div class="line">}</div>
</div><!-- fragment --><p>Example: </p><div class="fragment"><div class="line">{</div>
<div class="line">    ...</div>
<div class="line">    &quot;jobs&quot;: {</div>
<div class="line">        &quot;enabled&quot;: true,</div>
<div class="line">        &quot;handler-directory&quot;: &quot;~/.aws-iot-device-client/jobs/&quot;</div>
<div class="line">    }</div>
<div class="line">    ...</div>
<div class="line">}</div>
</div><!-- fragment --><p><a href="#jobs"><em>Back To The Top</em></a> </p>
</div></div><!-- contents -->
</div><!-- PageDoc -->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated by &#160;<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/>
</a> 1.8.17
</small></address>
</body>
</html>
